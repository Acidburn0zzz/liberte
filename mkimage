#!/bin/sh -e

sinfo() {
    echo -e "\033[1;33;41m$@\033[0m"
}


# Must have root directory as an argument
if [ "$1" = "" ]; then
    echo "$0 <livecd root>"
    exit 1
fi


# Variables
SRC=`realpath $0`
SRC=`dirname ${SRC}`
LIVECD=$1/clean
DIST=$1/dist
USBROOT=${DIST}/liberte


if which mksquashfs 1>/dev/null 2>&1; then
    mksquashfs=mksquashfs
else
    echo "SquashFS Tools not found"
    exit 1
fi

mksqversion=`${mksquashfs} -version | head -1 | cut -d' ' -f3`
if [ "${mksqversion}" != 4.0 ]; then
    echo "Need SquashFS Tools v4.0, but detected v${mksqversion}"
    exit 1
fi


sinfo "Copying USB /boot"
mkdir -p -m 755 ${USBROOT}
rsync -aHAXS -v --delete-excluded \
    ${LIVECD}/boot ${USBROOT}
sed -i 's/TAG/[USB]/; s/ROOTFS/vfat/' ${USBROOT}/boot/syslinux/syslinux.cfg


sinfo "Copying USB add-ons"
rsync -aHS -O --no-o --no-g --chmod=go=rX -v \
    --delete-excluded -C -f "P /boot/" \
    ${SRC}/dist/ ${USBROOT}


# Using default block size of 128KiB
sinfo "Creating SquashFS image"

${mksquashfs} ${LIVECD} ${USBROOT}/root-x86.squashfs -noappend \
    -no-exports -no-progress \
    -sort ${SRC}/rootfs.sort -e boot
chmod 644 ${USBROOT}/root-x86.squashfs


sinfo "Done."
