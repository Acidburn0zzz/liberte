#!/bin/sh -e

export LC_ALL=C


sinfo() {
    echo ${BASH:+-e} "\033[1;33;41m$@\033[0m"
}


# Must have root directory as an argument
if [ -z "$1" ]; then
    echo "$0 <livecd root>"
    exit 1
fi


# Variables
src=`dirname $0`
livecd=$1/copy
cdroot=$1/dist/cdroot

version=`cat ${src}/conf/version`
distname=liberte-${version}
sysver=`cat ${livecd}/boot/syslinux/version`
mksqver=4.2

luser=2101
lgroup=9000

# see /usr/local/sbin/ps-mount
vfatflags=noatime,noexec,flush,iocharset=iso8859-1,utf8,uid=${luser},gid=${lgroup},umask=0137,dmask=067
isofsflags=nosuid,nodev,iocharset=iso8859-1,utf8,uid=${luser},gid=${lgroup},dmode=0510
extflags=noatime,nosuid,nodev,acl,user_xattr


# POSIX shells should (probably) support $(())
mibsize() {
    bytes=`stat -c %s "$1"`
    echo $(((bytes + 512 * 1024) / (1024 * 1024)))
}


if type mksquashfs 1>/dev/null 2>&1; then
    mksquashfs=mksquashfs
else
    echo "SquashFS Tools not found"
    exit 1
fi

mksqversion=`${mksquashfs} -version | head -1 | cut -d' ' -f3`
if [ "${mksqversion}" != ${mksqver} ]; then
    echo "Need SquashFS Tools v${mksqver}, but detected v${mksqversion}"
    exit 1
fi


sinfo "Copying USB /boot"
mkdir -p -m 755 ${cdroot} ${cdroot}/liberte ${cdroot}/isolinux
rsync -aHAXS -i --delete-excluded --exclude /boot/syslinux/version \
    ${livecd}/boot ${cdroot}/liberte
sed -i "s/TAG //; s/ROOTFS/vfat/;    s/FSFLAGS/${vfatflags}/"  \
    ${cdroot}/liberte/boot/syslinux/syslinux.cfg

# EXTLINUX config takes precedence over SYSLINUX one when in same directory
mkdir -m 755 ${cdroot}/liberte/boot/syslinux/ext
cp -p ${livecd}/boot/syslinux/syslinux.cfg ${cdroot}/liberte/boot/syslinux/ext/extlinux.conf
sed -i "s/TAG //; s/ROOTFS/ext4/;    s/FSFLAGS/${extflags}/"   \
    ${cdroot}/liberte/boot/syslinux/ext/extlinux.conf

# ISOLINUX doesn't support RockRidge/Joliet, so must replace '-' in filenames
cp -p ${livecd}/boot/syslinux/syslinux.cfg ${cdroot}/liberte/boot/syslinux/isolinux.cfg
sed -i "s/TAG/[CD]/; s/ROOTFS/iso9660/; s/FSFLAGS/${isofsflags}/;
        s/theme:liberte/theme:liberty/;
        s/\(\(FONT\|LINUX\|INITRD\) [^-]*\)-/\1_/"             \
    ${cdroot}/liberte/boot/syslinux/isolinux.cfg
cp -p ${cdroot}/liberte/boot/syslinux/isolinux.cfg ${cdroot}/isolinux/isolinux.cfg


sinfo "Copying USB add-ons"
rsync -aHS -i -O --no-o --no-g --chmod=u=rwX,go=rX \
    --delete-excluded -C -f "P /boot/"             \
    ${src}/dist/ ${cdroot}/liberte
sed -i "s/SYSVER/${sysver}/" ${cdroot}/liberte/setup.sh


# Unreferenced files have default priority 0 (which is the top priority)
sinfo "Preparing <mimetype,dir,package> SquashFS ordering"
count=0 last= sqsort=`mktemp`
for p in ${livecd}/tmp/packages/unlisted-files ${livecd}/tmp/packages/*=*; do
    sed "s:^:${livecd}:" ${p} | file -zhN --mime-type -F '' -f - \
        | sed -n "s:^${livecd}/\(.*\)/\([^/]*\) \(.*\)$:\3 \1 ${p##*/} \1/\2:p"
done | sort | while read id1 id2 id3 file; do
    if [ "${id1},${id2},${id3}" != "${last}" ]; then
        count=$((count-1))
        last="${id1},${id2},${id3}"
    fi
    echo "${file}" ${count} >> ${sqsort}
done


# Using default block size of 128KiB
# Multi-threaded execution often causes deadlock after image creation
sinfo "Creating SquashFS image"

${mksquashfs} ${livecd} ${cdroot}/liberte/boot/root-x86.sfs          \
    -noappend -no-exports -no-progress -no-xattrs -comp xz -Xbcj x86 \
    -always-use-fragments -pf ${src}/conf/rootfs.pseudo              \
    -sort ${sqsort} -e boot dev tmp/packages
chmod 644 ${cdroot}/liberte/boot/root-x86.sfs
rm ${sqsort}


sinfo "Converting text files to DOS line endings"
find ${cdroot} \( -name '*.txt' -o -name '*.bat' -o -name '*.cfg' \) \
    -exec sed -i 's/$/\r/' {} \;


sinfo "Building binary distribution ${distname}.zip"
zipfile=${cdroot}/../${distname}.zip
(cd ${cdroot}; zip -FS -r9 -q ${zipfile} liberte)


# Hide root directories on Windows, and reset volume information
sinfo "Creating ISO image ${distname}.iso"
isofile=${cdroot}/../${distname}.iso
mkisofs -quiet -iso-level 2 -no-pad -J -sysid '' -V '' -A '' \
    -r -dir-mode 0510 -new-dir-mode 0510                     \
    -no-emul-boot -boot-load-size 4 -boot-info-table         \
    -c boot.cat -hide boot.cat -hide-joliet boot.cat         \
    -b liberte/boot/syslinux/isolinux.bin -o ${isofile}      \
    -hidden isolinux -hidden liberte -hide-joliet isolinux -hide-joliet liberte ${cdroot}
isovfy ${isofile}


echo "Disk usage: `du -s --apparent-size -B 1M ${cdroot} | cut -f1` MiB"
echo "ZIP size:   `mibsize ${zipfile}` MiB"
echo "ISO size:   `mibsize ${isofile}` MiB"


sinfo "Done."
