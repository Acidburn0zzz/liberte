#!/bin/sh -e

export TZ=:UTC

cableid=cable-id
cablesend=/usr/bin/cable-send
dummyaddr=anonymous@liberte
confdir=${XDG_CONFIG_HOME}/claws-mail


# Configure the Tor address if none is set
if grep -q "^address=${dummyaddr}\$" ${confdir}/accountrc \
    && username=`${cableid} user 2>/dev/null`; then

    torhost=`${cableid} tor`
    echo "Resetting account address to ${username}@${torhost}"

    sed -i "s/^\(address=\)${dummyaddr}\$/\1${username}@${torhost}/" \
        ${confdir}/accountrc
fi


# Legacy configuration support: the path has changed twice
if ! grep -q "^mail_command=${cablesend}\$" ${confdir}/accountrc; then
    sed -i "s:^\(mail_command=\).*:\1${cablesend}:" ${confdir}/accountrc
fi


# Run via torify for users who want additional "regular" accounts
exec torify /usr/bin/claws-mail --alternate-config-dir ${confdir} 2>/dev/null "$@"
