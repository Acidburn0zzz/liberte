#!/bin/sh

nofw=nofw
timeout=120


if [ ! -e /dev/kvm ]; then
    vmflag=`sed -n 's/^flags\>.*\<\(vmx\|svm\)\>.*$/\1/p' /proc/cpuinfo | head -n 1`

    if [ "${vmflag}" = vmx ]; then
        sudo modprobe kvm-intel
    elif [ "${vmflag}" = svm ]; then
        sudo modprobe kvm-amd
    fi
fi


xhost +si:localuser:${nofw}


# DISPLAY is preserved by sudo
pid=`unset XAUTHORITY; cd /tmp; sudo -n -u ${nofw} inception-backend`


if [ -n "${pid}" ] && kill -0 "${pid}" 2>/dev/null; then
    w=
    while [ ${#w} -lt ${timeout} ]; do
        sleep 1

        wid=`wmctrl -lp | awk "\$3==${pid} { print \$1 }"`
        if [ -n "${wid}" ]; then
            break;
        fi

        w=${w}X
    done
fi


xhost -si:localuser:${nofw}
