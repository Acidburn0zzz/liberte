#!/bin/sh

src=/home/anon/config/tor
dest=/var/lib/tor
dir=hidden_service

suser=anon:anon
duser=tor:tor

# Forked as waiter for saving tor config
if [ "$1" = fork ]; then
    while [ ! -s ${dest}/${dir}/hostname ]; do
        sleep 5
    done

    sleep 1
    rsync -aHS --no-o --no-g --no-p --chmod=go= ${dest}/${dir} ${src}
    chown -hR ${suser} ${src}/${dir}
# Already configured
elif [ -d ${src}/${dir} ]; then
    # Target exists: check equivalence
    if [ -d ${dest}/${dir} ]; then
        if ! cmp -s ${src}/${dir}/hostname ${dest}/${dir}/hostname; then
            echo "Warning: Existing Tor onion address is different from the one previously saved!"
            exit 1
        fi
    # Otherwise, propagate
    else
        rsync -aHS --no-o --no-g --no-p --chmod=go= ${src}/${dir} ${dest}
        chown -hR ${duser} ${dest}/${dir}
    fi
# If not, fork waiter
else
    "$0" fork &
fi
