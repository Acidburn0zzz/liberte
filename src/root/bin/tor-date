#!/bin/sh -e

conctimeout=120

tordir=/var/lib/tor/data
consensus=${tordir}/cached-consensus
descriptors=${tordir}/cached-descriptors

tag=tor-date


# Delegate time setting to other daemons if Tor connections work
if [ -e ${descriptors} ]; then
    logger -p 6 -t ${tag} "Tor has already opened a circuit, exiting"
    exit
fi


# Wait for the consensus file, which contains a valid time interval
w=
while [ ${#w} -lt ${conctimeout} ]; do
    if [ -e ${consensus} ] && egrep -q '^valid-after [ 0-9:-]{19}$' ${consensus}; then
        w=yes
        break;
    fi

    sleep 1
    w=${w}X
done

if [ "${w}" != yes ]; then
    logger -p 4 -t ${tag} "Timed out while waiting for consensus file"
    exit 1
fi


# Get various date points in Tor's format, and do some sanity checks
vstart=`sed -n 's/^valid-after //p' ${consensus} | head -n 1`
vend=`sed -n 's/^valid-until //p' ${consensus} | head -n 1`
vendchk=`date -ud "${vstart} -0300" +'%F %T'`

if [ "${vend}" != "${vendchk}" ]; then
    logger -p 3 -t ${tag} "Unexpected valid-until: [${vend}] is not [${vendchk}], exiting"
    exit 1
fi


# Check whether current time is in (conservative) range
curdate=`date -u +'%F %T'`
vendcons=`date -ud "${vstart} -0230" +'%F %T'`
vmid=`date -ud "${vstart} -0130" +'%F %T'`

order="${vstart}
${curdate}
${vendcons}"

ordersrt=`echo "${order}" | sort`

if [ "${order}" = "${ordersrt}" ]; then
    logger -p 6 -t ${tag} "Current time is in valid range, exiting"
    exit
fi


# Estimate time to the middle of the range
vmid=`date -ud "${vstart} -0130" +'%F %T'`
logger -p 6 -t ${tag} "Setting time to middle of valid range: [${vmid}]"
date -us "${vmid}" 1>/dev/null


# Tor is unreliable with picking a circuit after time change
if [ -e /var/lib/init.d/started/tor ]; then
    logger -p 6 -t ${tag} "Restarting Tor service"
    /etc/init.d/tor restart
fi
