#!/bin/bash -e

# sys-kernel/linux-firmware sublist
fwlst=/etc/portage/savedconfig/sys-kernel/linux-firmware

# initramfs image
initrd=/usr/src/linux/usr/initramfs_data.cpio.xz


# serial_cs:          necessary firmware included by kernel automatically
# b43, b43legacy:     net-wireless/b43-firmware
# atmel,at76c50x-usb: net-wireless/atmel-firmware
for fw in $(strings -a -n 10                               \
              $(find /lib/modules -name '*.ko'             \
                                  ! -name serial_cs.ko     \
                                  ! -name b43.ko           \
                                  ! -name b43legacy.ko     \
                                  ! -name atmel.ko         \
                                  ! -name at76c50x-usb.ko) \
              | sed -n 's/^firmware=//p'                   \
              | sort -u); do
    if [ ! -e /lib/firmware/${fw} ] && ! grep -q "^${fw}\$" ${fwlst}; then
        # Support older iwlwifi ucodes (IWL*_UCODE_API_MIN/OK)
        if [ ! -e /lib/firmware/${fw/-6.ucode/-5.ucode} ]; then
            echo ${fw}
        fi
    fi
done


# Ensure that initramfs modules do not require any firmware
for fw in $(strings -a -n 10                                           \
              $(bsdtar tf ${initrd} 'lib/modules/*.ko' | sed 's:^:/:') \
              | sed -n 's/^firmware=//p'                               \
              | sort -u); do
    echo initramfs: ${fw}
done
